<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicaid RFP Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .rfp-card {
            background-color: white;
            border-left: 4px solid #3b82f6;
        }
        .keyword {
            background-color: #e0f2fe;
            color: #0c4a6e;
        }
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 sm:p-8">
        <header class="flex flex-col sm:flex-row justify-between items-center bg-white p-6 sm:p-8 rounded-lg shadow-md mb-6">
            <div class="mb-4 sm:mb-0 text-center sm:text-left">
                <h1 class="text-3xl font-bold text-gray-800">Medicaid RFP Tracker</h1>
                <p class="text-gray-500">Monitor new Home and Community-Based Services (HCBS), Long-Term Services and Supports (LTSS), and Behavioral Health opportunities.</p>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="scan-now-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md shadow-lg hover:bg-blue-700 transition duration-300">
                    Scan Now
                </button>
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-500">Total RFPs Found</h3>
                <p id="total-rfps" class="mt-1 text-4xl font-bold text-gray-900">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-500">States Monitored</h3>
                <p id="states-monitored" class="mt-1 text-4xl font-bold text-gray-900">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-500">Recent RFPs (30 Days)</h3>
                <p id="recent-rfps" class="mt-1 text-4xl font-bold text-gray-900">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-500">Last Scan</h3>
                <p id="last-scan-time" class="mt-1 text-lg font-semibold text-gray-900">-</p>
                <p id="last-scan-duration" class="mt-1 text-sm text-gray-500">-</p>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md">
            <div id="loading-spinner" class="text-center py-10 hidden">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
                <p class="mt-4 text-gray-500">Scanning for new RFPs...</p>
            </div>
            <div id="rfps-container" class="space-y-4">
                <!-- RFP cards will be injected here -->
            </div>
        </section>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const scanNowBtn = document.getElementById('scan-now-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            async function fetchData() {
                try {
                    const response = await fetch('/api/rfps');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    displayStats(data.stats, data.rfps.length);
                    displayRFPs(data.rfps);
                } catch (error) {
                    console.error('Error fetching data:', error);
                    document.getElementById('rfps-container').innerHTML = 
                        '<div class="no-rfps text-center py-10 text-gray-500">Error loading RFPs. Please try again.</div>';
                }
            }

            function displayStats(stats, recentCount) {
                document.getElementById('total-rfps').textContent = stats.total_found || 0;
                document.getElementById('states-monitored').textContent = stats.states_monitored || 0;
                document.getElementById('recent-rfps').textContent = recentCount || 0;
                
                if (stats.last_scan) {
                    const lastScanTime = new Date(stats.last_scan);
                    document.getElementById('last-scan-time').textContent = lastScanTime.toLocaleString();
                    document.getElementById('last-scan-duration').textContent = `Duration: ${stats.last_scan_duration}s`;
                } else {
                    document.getElementById('last-scan-time').textContent = 'N/A';
                    document.getElementById('last-scan-duration').textContent = '';
                }
            }

            function displayRFPs(rfps) {
                const container = document.getElementById('rfps-container');
                container.innerHTML = '';
                
                if (rfps.length === 0) {
                    container.innerHTML = '<div class="no-rfps text-center py-10 text-gray-500">No RFPs found yet. Click "Scan Now" to search for opportunities.</div>';
                    return;
                }

                const rfpsHtml = rfps.map(rfp => `
                    <a href="${rfp.url}" target="_blank" class="block">
                        <div class="rfp-card p-4 rounded-lg shadow hover:shadow-lg transition duration-300">
                            <div class="flex justify-between items-center">
                                <div class="rfp-title text-xl font-semibold text-gray-800">${rfp.title}</div>
                                <div class="rfp-status">
                                    <span class="status-active text-xs font-medium px-2 py-1 rounded-full">${rfp.status}</span>
                                </div>
                            </div>
                            <div class="rfp-number text-gray-500 text-sm mt-1">RFP Number: ${rfp.rfp_number}</div>
                            <div class="rfp-meta text-sm text-gray-500 mt-2">
                                üìç ${rfp.state} ‚Ä¢ üè¢ ${rfp.source} ‚Ä¢ üìÖ ${new Date(rfp.found_date).toLocaleDateString()}
                            </div>
                            <div class="rfp-description text-gray-600 mt-2 line-clamp-3">${rfp.description}</div>
                            <div class="rfp-keywords flex flex-wrap gap-2 mt-3">
                                ${rfp.keywords_found.map(keyword => `<span class="keyword text-xs font-medium px-2 py-1 rounded-full">${keyword}</span>`).join('')}
                            </div>
                        </div>
                    </a>
                `).join('');
                
                container.innerHTML = rfpsHtml;
            }

            scanNowBtn.addEventListener('click', async () => {
                loadingSpinner.classList.remove('hidden');
                document.getElementById('rfps-container').innerHTML = '';
                try {
                    const response = await fetch('/api/scan');
                    const result = await response.json();
                    if (result.success) {
                        await fetchData(); // Fetch and display the new data
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Manual scan failed:', error);
                    document.getElementById('rfps-container').innerHTML = 
                        '<div class="no-rfps text-center py-10 text-gray-500">Error during scan. Please check the server logs.</div>';
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            });

            // Initial data fetch
            fetchData();
        });
    </script>
</body>
</html>
